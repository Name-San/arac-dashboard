<script>
// Dashboard Functionality
const slides = document.querySelectorAll('.slide');
const progressBars = document.querySelectorAll('.progress');
const pauseBtn = document.getElementById('pauseBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const slideIndicator = document.getElementById('slideIndicator');
const fullscreenMessage = document.getElementById('fullscreenMessage');
const presentationToggle = document.getElementById('presentationToggle');
const exitPresentation = document.getElementById('exitPresentation');
const projectCards = document.querySelectorAll('.project-card');

let currentSlide = 0;
let slideDuration = 15000; // 15 seconds per slide
let slideInterval;
let isPaused = false;

// Set up progress rings
function setProgressRing(id, percentage) {
    const circle = document.getElementById(id);
    const radius = circle.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;
    
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    const offset = circumference - (percentage / 100) * circumference;
    circle.style.strokeDashoffset = offset;
}

// Initialize progress rings
setProgressRing('progress-ring-1', 42);
setProgressRing('progress-ring-2', 35);
setProgressRing('progress-ring-3', 28);

// Toggle presentation mode
presentationToggle.addEventListener('click', () => {
    document.body.classList.add('presentation-mode');
    showSlide(0);
    startSlideshow();
    
    // Show fullscreen message
    fullscreenMessage.classList.add('show');
    setTimeout(() => {
        fullscreenMessage.classList.remove('show');
    }, 5000);
});

// Exit presentation mode
exitPresentation.addEventListener('click', () => {
    document.body.classList.remove('presentation-mode');
    clearInterval(slideInterval);
    resetProgress();
});

// Project card click handlers
projectCards.forEach(card => {
    card.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-details-btn') || e.target.closest('.view-details-btn')) {
            const projectId = card.getAttribute('data-project');
            document.body.classList.add('presentation-mode');
            goToSlide(parseInt(projectId) - 1);
            startSlideshow();
        }
    });
});

function startSlideshow() {
    clearInterval(slideInterval);
    slideInterval = setInterval(() => {
        if (!isPaused) {
            nextSlide();
        }
    }, slideDuration);
}

function resetProgress() {
    progressBars.forEach(bar => {
        bar.style.width = '0%';
    });
}

function updateProgress() {
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (isPaused) return;
        progress += 0.1;
        progressBars[currentSlide].style.width = `${progress}%`;
        if (progress >= 100) {
            clearInterval(progressInterval);
        }
    }, slideDuration / 1000);
}

function showSlide(index) {
    if (document.body.classList.contains('presentation-mode')) {
        slides.forEach(slide => {
            slide.classList.remove('active');
        });
        
        document.querySelectorAll('.indicator').forEach((ind, i) => {
            ind.classList.toggle('active', i === index);
        });
        
        slides[index].classList.add('active');
        resetProgress();
        updateProgress();
    }
}

function nextSlide() {
    currentSlide = (currentSlide + 1) % slides.length;
    showSlide(currentSlide);
}

function prevSlide() {
    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
    showSlide(currentSlide);
}

function goToSlide(index) {
    currentSlide = index;
    showSlide(currentSlide);
    clearInterval(slideInterval);
    startSlideshow();
}

// Event listeners
pauseBtn.addEventListener('click', () => {
    isPaused = !isPaused;
    pauseBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
});

prevBtn.addEventListener('click', () => {
    prevSlide();
    clearInterval(slideInterval);
    startSlideshow();
});

nextBtn.addEventListener('click', () => {
    nextSlide();
    clearInterval(slideInterval);
    startSlideshow();
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (!document.body.classList.contains('presentation-mode')) return;
    
    if (e.key === 'ArrowRight') {
        nextSlide();
        clearInterval(slideInterval);
        startSlideshow();
    } else if (e.key === 'ArrowLeft') {
        prevSlide();
        clearInterval(slideInterval);
        startSlideshow();
    } else if (e.key === ' ') {
        isPaused = !isPaused;
        pauseBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
        e.preventDefault(); // Prevent page scrolling on spacebar
    } else if (e.key === 'Escape') {
        document.body.classList.remove('presentation-mode');
        clearInterval(slideInterval);
        resetProgress();
    }
});

// Create Slide
function createSlide(project, cardsData) {
    // Create Slides
    const slide = document.createElement('div')
    slide.classList.add("slide")

    const outerDiv = document.createElement('div')
    outerDiv.className = 'min-h-screen p-6';

    // Create Header
    const divHeader = document.createElement('div');
    divHeader.className = "flex justify-between items-center mb-6";

    const headerDiv1 = document.createElement('div');
    const projectTitle = document.createElement('h1');
    projectTitle.className = "text-3xl font-bold";
    projectTitle.innerHTML = project.name;

    const projectId = document.createElement('p');
    projectId.className = "text-lg opacity-80";
    projectId.textContent = project.id;

    headerDiv1.append(projectTitle, projectId);

    const headerDiv2 = document.createElement('div');
    headerDiv2.className = "flex items-center gap-4";

    const statusPanel = document.createElement('div');
    statusPanel.classList.add('text-right');

    const location = document.createElement('p');
    location.className = "text-sm opacity-70";
    location.innerHTML = project.location;

    const deadline = document.createElement('p');
    deadline.className = "text-sm opacity-70";
    deadline.innerHTML = project.deadline;

    statusPanel.append(location, deadline);

    const status = document.createElement('div');
    status.className = "status-badge bg-green-500 bg-opacity-20 text-green-300 border border-green-500";
    status.innerHTML = project.status;

    headerDiv2.append(status, statusPanel);

    divHeader.append(headerDiv1, headerDiv2);


    // Create Cards
    const divCards = document.createElement('div');
    divCards.className = "grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6";
    const colorClass = ['from-blue-600 to-blue-800','from-indigo-600 to-indigo-800','from-purple-600 to-purple-800','from-pink-600 to-pink-800'];
    cardsData.forEach((c,i) => {
        const card = document.createElement('div');
        card.className = `stats-card bg-gradient-to-br p-4 rounded-xl ${colorClass[i]}`;

        const h3 = document.createElement('h3');
        h3.className = "text-sm font-medium opacity-80";
        h3.textContent = c.card;

        const stats = document.createElement('div');
        stats.className = 'flex items-end justify-between mt-2';

        const main = document.createElement('p')
        main.className = 'text-3xl font-bold';
        main.textContent = c.main;

        const subStat = document.createElement('div');
        subStat.classList.add('text-right');

        const subTitle = document.createElement('p');
        subTitle.className = 'text-xs opacity-70';
        subTitle.textContent = c.subtitle;

        subStat.append(subTitle)

        stats.append(main, subStat);

        card.append(h3, stats);

        divCards.appendChild(card);
    })

    // Create charts
    const divCharts = document.createElement('div')
    divCharts.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6';

    const activities = new Array()
    const targets = new Array()
    const completed = new Array()
    const activityStatus = new Array(3);

    project.projectData.values.forEach((row, i) => {
        if (i < row.length-1) {
            activities.push(row[0]);
            targets.push(row[row.length-1]);
            completed.push(row.length-2);
        }        
    })

    for (let i=0; i<completed.length; i++) {
        if (completed[i] == targets[i]) {
            activityStatus[0] ? activityStatus[0]++ : activityStatus[0] = 1;
        }
        else if (!completed[i]) {
            activityStatus[2] ? activityStatus[2]++ : activityStatus[2] = 1;
        }
        else {
            activityStatus[1] ? activityStatus[1]++ : activityStatus[1] = 1;
        }
    }

    for (let i=1; i<=2; i++) {
        const chartCard = document.createElement('div')
        chartCard.className = 'card bg-white bg-opacity-10 backdrop-blur-lg p-4';
        if (i==1) chartCard.classList.add('col-span-2');

        const chartTitle = document.createElement('h2')
        chartTitle.className = 'text-lg font-semibold mb-2';
        chartTitle.textContent = "Completion vs. Target (%)";

        const miniChart = document.createElement('div')
        miniChart.className = 'mini-chart';
        const chartCanva = document.createElement('canvas');

        const chartCtx = chartCanva.getContext('2d');
        let completionChart;
        if (i == 1) {
            completionChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: activities,
                    datasets: [
                        {
                            label: 'Completed (%)',
                            data: completed,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Target (%)',
                            data: targets,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(targets),
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        } else {
            completionChart = new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: activityStatus,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }

        miniChart.append(chartCanva);

        chartCard.append(chartTitle, miniChart);

        divCharts.append(chartCard);
    }

    

    // Create Table
    const divTable = document.createElement('div');
    divTable.className = 'card bg-white bg-opacity-10 backdrop-blur-lg p-4';

    const tableTitle = document.createElement('div');
    tableTitle.className = 'flex justify-between items-center mb-4';
    const h2Title = document.createElement('h2');
    h2Title.className = 'text-lg font-semibold';
    h2Title.textContent = "Project Activities";
    const pDescription = document.createElement('p')
    pDescription.className = 'text-sm opacity-70';
    pDescription.textContent = 'Road expansion for better spaces and area of roadway';

    tableTitle.append(h2Title, pDescription);

    const tableDiv = document.createElement('div');
    tableDiv.classList.add('table-container');
    const table = document.createElement('table');
    table.classList.add('w-full');
    const thead = document.createElement('thead');
    const rowHeaders = document.createElement('tr');
    project.projectData.headers.forEach(header => {
        let tableHeader = document.createElement('th');
        tableHeader.classList.add('text-center');
        tableHeader.textContent = header;
        rowHeaders.appendChild(tableHeader);
    })

    thead.appendChild(rowHeaders);

    const tbody = document.createElement('tbody');
    project.projectData.values.forEach(row => {
        const rowTable = document.createElement('tr');
        rowTable.className = 'hover:bg-white hover:bg-opacity-10';
        row.forEach((data, i) => {
            const rowValue = document.createElement('td');
            if (i!=0) rowValue.classList.add('text-right')
            rowValue.textContent = data;
            rowTable.appendChild(rowValue);
        })
        tbody.appendChild(rowTable);
    })    

    table.append(thead, tbody);
    tableDiv.append(table);
    divTable.append(tableTitle, tableDiv);
    outerDiv.append(divHeader, divCards, divCharts, divTable)

    //Progress Bar
    const divProgress = document.createElement('div');
    divProgress.classList.add('progress-bar');
    divProgress.innerHTML = '<div class="progress"></div>';

    slide.appendChild(outerDiv, divProgress);

    document.body.append(slide);
}

function createDashboard(overallChartData) {
    const targetMax = Math.max(overallChartData.target)
    const overallCtx = document.getElementById('overallProgressChart').getContext('2d');
    const overallChart = new Chart(overallCtx, {
        type: 'bar',
        data: {
            labels: overallChartData.label,
            datasets: [
                {
                    label: 'Current Completion (%)',
                    data: overallChartData.completed,
                    backgroundColor: ['rgba(74, 222, 128, 0.7)', 'rgba(250, 204, 21, 0.7)', 'rgba(248, 113, 113, 0.7)'],
                    borderColor: ['rgba(74, 222, 128, 1)', 'rgba(250, 204, 21, 1)', 'rgba(248, 113, 113, 1)'],
                    borderWidth: 1
                },
                {
                    label: 'Target Completion (%)',
                    data: overallChartData.target,
                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: targetMax,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });
}


// Iniatiate Setting Data
function setProjectData(projects) {
    // Create Data for Overall chart
    const overallChartData = {
        label: [],
        completed: [],
        target: [],
        backgroundColor: [],
        borderColor: []
    }

    for (const project of projects) {
        const totalRow = project.projectData.values.filter(row => row[0] == 'Total');
        overallChartData.label.push(project.name);

        // Create cards data
        const cardsData = new Array(4);

        // For deadline card
        const msDiff = new Date(project.deadline) - new Date();
        const daysCount = Math.ceil(msDiff / (1000 * 60 * 60 * 24));
        cardsData[2] = {
            card: 'Days Remaining',
            main: daysCount,
            subtitle: 'On Schedule'
        }
        
        project.projectData.headers.forEach((item, index) => {
            if (item == 'Completed') {
                const [completed, target] = totalRow[0].filter((val,i) => i == index || i == index+1);
                
                overallChartData.completed.push(completed);
                overallChartData.target.push(target)

                const percentage = Math.round((completed / target) * 100);
                cardsData[0] = {
                    card: 'Overall Completion',
                    main: `${percentage}%`,
                    subtitle: `Target: ${target}`
                }
            }

            if (/Balance.*/.test(item)) {
                let doneActivites = 0;
                project.projectData.values.forEach((val, i) => {
                    if (!val[index]) {
                        doneActivites++;
                    }
                })
                cardsData[1] = {
                    card: 'Activities Completed',
                    main: `${doneActivites}/${project.projectData.values[0].length - 1}`,
                    subtitle: `Remaining: ${project.projectData.values[0].length - 1 - doneActivites}`
                }
            }

            if (/Work.*/.test(item)) {
                const [accomplished] = totalRow[0].filter((val,i) => i == index);
                cardsData[3] = {
                    card: '3-Day Progress',
                    main: accomplished,
                    subtitle: 'Units completed'
                }
            }
        })

        createSlide(project, cardsData);
    }

    createDashboard(overallChartData);
}

// Charts
document.addEventListener('DOMContentLoaded', function() {
    // Get Data
    google.script.run
        .withSuccessHandler(({ projects }) => {
            setProjectData(projects);

        })
        .withFailureHandler(error => {
            console.error(error.message)
            return
        })
        .getDashboardData()

});

// Create slide indicators
slides.forEach((_, index) => {
    const indicator = document.createElement('div');
    indicator.classList.add('indicator');
    if (index === 0) indicator.classList.add('active');
    indicator.addEventListener('click', () => goToSlide(index));
    slideIndicator.appendChild(indicator);
});
</script>