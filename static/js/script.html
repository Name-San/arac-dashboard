<script>
// STATIC NODES
const pauseBtn = document.getElementById('pauseBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const slideIndicator = document.getElementById('slideIndicator');
const fullscreenMessage = document.getElementById('fullscreenMessage');
const presentationToggle = document.getElementById('presentationToggle');
const exitPresentation = document.getElementById('exitPresentation');

// BASIC CONF
let currentSlide = 0;
let slideDuration = 15000; // 15 seconds per slide
let slideInterval;
let isPaused = false;

// CLIENT-SIDE CONTROL FUNCTIONS
function startSlideshow() {
    clearInterval(slideInterval);
    slideInterval = setInterval(() => {
        if (!isPaused) {
            nextSlide();
        }
    }, slideDuration);
}

function resetProgress() {
    progressBars.forEach(bar => {
        bar.style.width = '0%';
    });
}

function updateProgress() {
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (isPaused) return;
        progress += 0.1;
        progressBars[currentSlide].style.width = `${progress}%`;
        if (progress >= 100) {
            clearInterval(progressInterval);
        }
    }, slideDuration / 1000);
}

function showSlide(index) {
    if (document.body.classList.contains('presentation-mode')) {
        slides.forEach(slide => {
            slide.classList.remove('active');
        });
        
        document.querySelectorAll('.indicator').forEach((ind, i) => {
            ind.classList.toggle('active', i === index);
        });
        
        slides[index].classList.add('active');
        resetProgress();
        updateProgress();
    }
}

function nextSlide() {
    currentSlide = (currentSlide + 1) % slides.length;
    showSlide(currentSlide);
}

function prevSlide() {
    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
    showSlide(currentSlide);
}

function goToSlide(index) {
    currentSlide = index;
    showSlide(currentSlide);
    clearInterval(slideInterval);
    startSlideshow();
}

// EVENT LISTERNER
// Toggle presentation mode
presentationToggle.addEventListener('click', () => {
    document.body.classList.add('presentation-mode');
    showSlide(0);
    startSlideshow();
    
    // Show fullscreen message
    fullscreenMessage.classList.add('show');
    setTimeout(() => {
        fullscreenMessage.classList.remove('show');
    }, 5000);
});

// Exit presentation mode
exitPresentation.addEventListener('click', () => {
    document.body.classList.remove('presentation-mode');
    clearInterval(slideInterval);
    resetProgress();
});

pauseBtn.addEventListener('click', () => {
    isPaused = !isPaused;
    pauseBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
});

prevBtn.addEventListener('click', () => {
    prevSlide();
    clearInterval(slideInterval);
    startSlideshow();
});

nextBtn.addEventListener('click', () => {
    nextSlide();
    clearInterval(slideInterval);
    startSlideshow();
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (!document.body.classList.contains('presentation-mode')) return;
    
    if (e.key === 'ArrowRight') {
        nextSlide();
        clearInterval(slideInterval);
        startSlideshow();
    } else if (e.key === 'ArrowLeft') {
        prevSlide();
        clearInterval(slideInterval);
        startSlideshow();
    } else if (e.key === ' ') {
        isPaused = !isPaused;
        pauseBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
        e.preventDefault(); // Prevent page scrolling on spacebar
    } else if (e.key === 'Escape') {
        document.body.classList.remove('presentation-mode');
        clearInterval(slideInterval);
        resetProgress();
    }
});

// ONLOAD NODES
// Create Slide
function createSlide(slideData) {
    // Create Slides
    const slide = document.createElement('div')
    slide.classList.add("slide")

    const outerDiv = document.createElement('div')
    outerDiv.className = 'min-h-screen p-6';

    // Create Header
    const divHeader = document.createElement('div');
    divHeader.className = "flex justify-between items-center mb-6";

    const headerDiv1 = document.createElement('div');
    const projectTitle = document.createElement('h1');
    projectTitle.className = "text-3xl font-bold";
    projectTitle.innerHTML = slideData.name;

    const projectId = document.createElement('p');
    projectId.className = "text-lg opacity-80";
    projectId.textContent = slideData.id;

    headerDiv1.append(projectTitle, projectId);

    const headerDiv2 = document.createElement('div');
    headerDiv2.className = "flex items-center gap-4";

    const statusPanel = document.createElement('div');
    statusPanel.classList.add('text-right');

    const location = document.createElement('p');
    location.className = "text-sm opacity-70";
    location.innerHTML = slideData.location;

    const deadline = document.createElement('p');
    deadline.className = "text-sm opacity-70";
    deadline.innerHTML = slideData.deadline;

    statusPanel.append(location, deadline);

    const status = document.createElement('div');
    status.className = "status-badge bg-green-500 bg-opacity-20 text-green-300 border border-green-500";
    status.innerHTML = slideData.status;

    headerDiv2.append(status, statusPanel);

    divHeader.append(headerDiv1, headerDiv2);


    // Create Cards
    const divCards = document.createElement('div');
    divCards.className = "grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6";
    const colorClass = ['from-blue-600 to-blue-800','from-indigo-600 to-indigo-800','from-purple-600 to-purple-800','from-pink-600 to-pink-800'];
    slideData.cards.forEach((c,i) => {
        const card = document.createElement('div');
        card.className = `stats-card bg-gradient-to-br p-4 rounded-xl ${colorClass[i]}`;

        const h3 = document.createElement('h3');
        h3.className = "text-sm font-medium opacity-80";
        h3.textContent = c.card;

        const stats = document.createElement('div');
        stats.className = 'flex items-end justify-between mt-2';

        const main = document.createElement('p')
        main.className = 'text-3xl font-bold';
        main.textContent = c.value;

        const subStat = document.createElement('div');
        subStat.classList.add('text-right');

        const subTitle = document.createElement('p');
        subTitle.className = 'text-xs opacity-70';
        subTitle.textContent = c.description;

        subStat.append(subTitle)

        stats.append(main, subStat);

        card.append(h3, stats);

        divCards.appendChild(card);
    })

    // Create charts
    const divCharts = document.createElement('div')
    divCharts.className = 'grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6';

    for (let i=1; i<=2; i++) {
        const chartCard = document.createElement('div')
        chartCard.className = 'card bg-white bg-opacity-10 backdrop-blur-lg p-4';
        if (i==1) chartCard.classList.add('col-span-2');

        const chartTitle = document.createElement('h2')
        chartTitle.className = 'text-lg font-semibold mb-2';
        chartTitle.textContent = "Completion vs. Target (%)";

        const miniChart = document.createElement('div')
        miniChart.className = 'mini-chart';
        const chartCanva = document.createElement('canvas');

        const chartCtx = chartCanva.getContext('2d');
        let completionChart;
        if (i == 1) {
            completionChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: slideData.charts.activities,
                    datasets: [
                        {
                            label: 'Completed (%)',
                            data: slideData.charts.completed,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Target (%)',
                            data: slideData.charts.targets,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(slideData.charts.targets),
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        } else {
            completionChart = new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: slideData.charts.activityStatus,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }

        miniChart.append(chartCanva);

        chartCard.append(chartTitle, miniChart);

        divCharts.append(chartCard);
    }

    

    // Create Table
    const divTable = document.createElement('div');
    divTable.className = 'card bg-white bg-opacity-10 backdrop-blur-lg p-4';

    const tableTitle = document.createElement('div');
    tableTitle.className = 'flex justify-between items-center mb-4';
    const h2Title = document.createElement('h2');
    h2Title.className = 'text-lg font-semibold';
    h2Title.textContent = "Project Activities";
    const pDescription = document.createElement('p')
    pDescription.className = 'text-sm opacity-70';
    pDescription.textContent = slideData.description;

    tableTitle.append(h2Title, pDescription);

    const tableDiv = document.createElement('div');
    tableDiv.classList.add('table-container');
    const table = document.createElement('table');
    table.classList.add('w-full');
    const thead = document.createElement('thead');
    const rowHeaders = document.createElement('tr');
    slideData.table.headers.forEach(header => {
        let tableHeader = document.createElement('th');
        tableHeader.classList.add('text-center');
        tableHeader.textContent = header;
        rowHeaders.appendChild(tableHeader);
    })

    thead.appendChild(rowHeaders);

    const tbody = document.createElement('tbody');
    slideData.table.values.forEach(row => {
        const rowTable = document.createElement('tr');
        rowTable.className = 'hover:bg-white hover:bg-opacity-10';
        row.forEach((data, i) => {
            const rowValue = document.createElement('td');
            if (i!=0) rowValue.classList.add('text-right')
            rowValue.textContent = data;
            rowTable.appendChild(rowValue);
        })
        tbody.appendChild(rowTable);
    })    

    table.append(thead, tbody);
    tableDiv.append(table);
    divTable.append(tableTitle, tableDiv);
    outerDiv.append(divHeader, divCards, divCharts, divTable)

    //Progress Bar
    const divProgress = document.createElement('div');
    divProgress.classList.add('progress-bar');
    divProgress.innerHTML = '<div class="progress"></div>';

    slide.appendChild(outerDiv, divProgress);

    document.body.append(slide);
}

// Design Dashboards
function createDashboard(dashboardData, projects) {
    // Simplf Data
    const projects = dashboardData.projects;
    const totalTarget = dashboardData.totalTarget;
    const totalCompleted = dashboardData.totalCompleted;
    const totalDone = dashboardData.totalDone;
    const totalActivities = dashboardData.totalActivities;
    const onTrack = dashboardData.onTrack;
    const onComplete = dashboardData.onComplete;

    // Get Nodes
    const updatedDate = document.getElementById('updated-date');
    const projectCount = document.getElementById('project-count');
    const avgCompletion = document.getElementById('avg-completion');
    const targetAmount = document.getElementById('target-amount');
    const doneActv = document.getElementById('done-actv');
    const remainActv = document.getElementById('remain-actv');
    const projectOnTrack = document.getElementById('project-ontrack');
    const projectComplete = document.getElementById('project-complete');

    const progressBars = document.querySelectorAll('.progress');
    const projectCards = document.querySelectorAll('.project-card');

    // Header
    updatedDate.textContent = `Last Updated: ${new Date()}`;
    projectCount.textContent = `${projects.length} Active Projects`;

    // Summary Stats
    const sumCompleted = totalCompleted.reduce((sum, item) => sum + item);
    const sumTarget = totalCompleted.reduce((sum, item) => sum + item);
    const sumDone = totalDone.reduce((sum, item) => sum + item);
    const sumActivities = totalActivities.reduce((sum, item) => sum + item);

    avgCompletion.textContent = `${Math.ceil((sumCompleted/sumTarget)*100)}%`;
    targetAmount.textContent = `Target: ${sumTarget}`
    doneActv.textContent = `${sumDone}/${sumActivities}`
    remainActv.textContent = `Remaining: ${sumActivities - sumDone}`;
    projectOnTrack.textContent = `${onTrack}/${projects.length - onComplete}`;
    projectComplete.textContent = `Completed: ${onComplete}`;


    // Dashboard Charts
    const targetMax = Math.max(dashboardData.totalTarget)
    const overallCtx = document.getElementById('overallProgressChart').getContext('2d');
    const overallChart = new Chart(overallCtx, {
        type: 'bar',
        data: {
            labels: dashboardData.label,
            datasets: [
                {
                    label: 'Current Completion (%)',
                    data: dashboardData.completed,
                    backgroundColor: ['rgba(74, 222, 128, 0.7)', 'rgba(250, 204, 21, 0.7)', 'rgba(248, 113, 113, 0.7)'],
                    borderColor: ['rgba(74, 222, 128, 1)', 'rgba(250, 204, 21, 1)', 'rgba(248, 113, 113, 1)'],
                    borderWidth: 1
                },
                {
                    label: 'Target Completion (%)',
                    data: dashboardData.target,
                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: targetMax,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });

    // Project Cards
    const circumference = 32 * 2 * Math.PI;
    const cardsContainer = document.getElementById('project-cards-container');
    project.forEach((project, i) => {
        
        const percentage = Math.ceil((project.charts.completed / project.charts.activities.length) * 100);

        const projectCard = document.createElement('div');
        projectCard.setAttribute('data-project', i+1)
        projectCard.className = "project-card card bg-white bg-opacity-10 backdrop-blur-lg p-5";
        projectCard.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div>
                <h3 class="text-lg font-semibold">${project.name}</h3>
                <p class="text-sm opacity-70">ID: ${project.id}</p>
            </div>
            <div class="status-badge bg-opacity-20 border 
            ${ 
                project.status == 'On Track'
                ? 'bg-green-500 text-green-300 border-green-500'
                : project.status == 'Completed'
                    ? 'bg-blue-500 text-blue-300 border-blue-500'
                    : 'bg-red-500 text-red-300 border-red-500'
            } 
            ">
            ${project.status}
           </div>  
        </div>

        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-sm opacity-70">Location: ${project.location}</p>
                <p class="text-sm opacity-70">Deadline: ${project.deadline}</p>
                <p class="text-sm opacity-70">Days Left: ${project.cards[2].value}}</p>
            </div>
            <div class="progress-ring-container">
                <svg class="progress-ring" width="80" height="80">
                    <circle class="progress-ring-circle" id="progress-ring-1"
                        stroke="
                        ${ 
                            project.status == 'On Track'
                            ? '#4ade80'
                            : project.status == 'Completed' 
                                ? '#93c5fd'
                                : '#4ade80'
                        }"
                        stroke-width="8"
                        fill="transparent"
                        r="32"
                        cx="40"
                        cy="40"
                        style="
                        strokeDasharray:'${circumference} ${circumference}';
                        strokeDashoffset: '${circumference - (project.cards[0].value / 100) * circumference}';
                        "
                        />
                </svg>
                <div class="progress-ring-text 
                ${ 
                    project.status == 'On Track' 
                    ? 'text-green-300'
                    : project.status == 'Completed'
                        ? 'text-blue-300 '
                        : 'text-red-300'
                } 
                ">${project.cards[0].value}%</div>
            </div>
        </div>
        

        <div class="mt-4">
            <div class="flex justify-between text-sm mb-1">
                <span>Activities Completed:</span>
                <span>${project.cards[1].value}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
        </div>

        <div class="mt-4 flex justify-end items-center">
            <button class="view-details-btn bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-1 px-3 rounded-lg transition-all">
                View Details
            </button>
        </div>
        `
        // Project card click handlers
        projectCard.addEventListener('click', (e) => {
            e.preventDefault();
            if(e.target.classList.contains('view-details-btn') || e.target.closest('.view-details-btn')) {
                const projectId = card.getAttribute('data-project');
                document.body.classList.add('presentation-mode');
                goToSlide(parseInt(projectId) - 1);
                startSlideshow();
            }

        })

        cardsContainer.appendChild(projectCard);
    });
}

// Setup Data
function setProjectData(projects) {
    // Create Data for Overall chart
    const dashboardData = {
        projects: [],
        totalCompleted: [],
        totalTarget: [],
        totalDone: [],
        totalActivities: [],
        onTrack: 0,
        onComplete: 0,
    } 

    for (const project of projects) {
        // simplify
        const projectHeaders = project.projectData.headers;
        const projectValues = project.projectData.values;
        project['cards'] = new Array(3);
        project['charts'] = {};


        // Formating Activities and Status related data : GENERAL
        // Set Slide Charts Data
        projectValues.forEach((row, i) => {
            if (i < row.length-1) {
                project.charts.activities ? slideData.charts.activities.push(row[0]) : slideData.charts.activities = [row[0]];

                project.charts.targets ? slideData.charts.targets.push(row[row.length-1]) : slideData.charts.targets = [row[row.length-1]];

                project.charts.completed ? slideData.charts.completed.push(row[row.length-2]) : slideData.charts.completed = [row[row.length-2]];
            }        
        })

        const activityStatus = new Array(3);
        for (let i=0; i<slideData.charts.completed.length; i++) {
            if (completed[i] == targets[i]) {
                activityStatus[0] ? activityStatus[0]++ : activityStatus[0] = 1;
            }
            else if (!completed[i]) {
                activityStatus[2] ? activityStatus[2]++ : activityStatus[2] = 1;
            }
            else {
                activityStatus[1] ? activityStatus[1]++ : activityStatus[1] = 1;
            }
        }        
        project.charts['activityStatus'] = activityStatus;

        // Set Slides Cards Data
        const [totalTarget, totalComplete] = projectValues[-1].slice(-2);
        const percentage = Math.round((totalComplete / totalTarget) * 100);
        // card1
        project.cards[0] = {
            card: 'Overall Completion',
            value: `${percentage}%`,
            description: `Target: ${target}`
        }
        // card2
        project.cards[1] = {
            card: 'Activities Completed',
            value: `${slideData.charts.activityStatus[0]}/${slideData.charts.activities.length}`,
            description: `Remaining: ${slideData.charts.activities.length - slideData.charts.activityStatus[0]}`
        }
        // card3
        const msDiff = new Date(slideData.deadline) - new Date();
        const daysCount = Math.ceil(msDiff / (1000 * 60 * 60 * 24));
        project.cards[2] = {
            card: 'Days Remaining',
            value: daysCount,
            description: 'On Schedule'
        }               

        dashboardData.projects.push(project.name);
        dashboardData.totalCompleted.push(totalComplete);
        dashboardData.totalTarget.push(totalTarget);
        dashboardData.totalDone.push(project.charts.completed);
        dashboardData.totalActivities.push(project.charts.activities);

        if (slideData.status == 'On Track') {
            dashboardData.onTrack += 1;
        } else if (slideData.status == 'Completed') {
            dashboardData.onComplete += 1;
        }

        // Slides indicator
        const indicator = document.createElement('div');
        indicator.classList.add('indicator');
        if (index === 0) indicator.classList.add('active');
        indicator.addEventListener('click', () => goToSlide(index));
        slideIndicator.appendChild(indicator);

        createSlide(project);
    }

    createDashboard(dashboardData, projects);
}

// Charts
document.addEventListener('DOMContentLoaded', function() {
    // Get Data
    google.script.run
        .withSuccessHandler(({ projects }) => {
            setProjectData(projects);

        })
        .withFailureHandler(error => {
            console.error(error.message)
            return
        })
        .getDashboardData()

});
</script>